<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨å½¢æ€åˆ†æç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 12px;
            color: #666;
        }
        
        select, input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .stats {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.red {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .pattern-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .results-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .pattern-section {
            margin-bottom: 30px;
        }
        
        .pattern-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .stock-table th,
        .stock-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .stock-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .stock-table tr:hover {
            background: #f8f9fa;
        }
        
        .return-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .return-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stock-table {
                font-size: 12px;
            }
            
            .stock-table th,
            .stock-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ˆ è‚¡ç¥¨å½¢æ€åˆ†æç³»ç»Ÿ</h1>
            <p class="subtitle">åŸºäºKçº¿å½¢æ€çš„æ™ºèƒ½åˆ†ç±»ä¸æ¶¨è·Œå¹…åˆ†æ</p>
        </header>
        
        <div class="controls">
            <div class="control-group">
                <label>æ—¶é—´å‘¨æœŸ</label>
                <select id="periodType">
                    <option value="3m">3ä¸ªæœˆ</option>
                    <option value="6m">6ä¸ªæœˆ</option>
                    <option value="9m">9ä¸ªæœˆ</option>
                    <option value="12m">12ä¸ªæœˆ</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div class="control-group" id="customDateGroup" style="display: none;">
                <label>è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="startDate">
                    <input type="date" id="endDate">
                </div>
            </div>
            <button class="btn-primary" onclick="analyze()">ğŸ” å¼€å§‹åˆ†æ</button>
            <button class="btn-secondary" onclick="refreshCache()">ğŸ”„ åˆ·æ–°ç¼“å­˜</button>
        </div>
        
        <div id="messageArea"></div>
        
        <div class="stats" id="statsArea" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalStocks">0</div>
                <div class="stat-label">æ€»è‚¡ç¥¨æ•°</div>
            </div>
            <div class="stat-card green">
                <div class="stat-value" id="avgReturn">0%</div>
                <div class="stat-label">å¹³å‡æ¶¨å¹…</div>
            </div>
            <div class="stat-card red">
                <div class="stat-value" id="topPattern">-</div>
                <div class="stat-label">æœ€å¤šå½¢æ€</div>
            </div>
        </div>
        
        <div class="pattern-tabs" id="patternTabs"></div>
        
        <div class="results-container" id="resultsArea">
            <div class="loading" id="loading">ç‚¹å‡»"å¼€å§‹åˆ†æ"è·å–å½¢æ€åˆ†ç±»ç»“æœ</div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000';
        let currentResults = null;
        let activeTab = null;
        
        const patternNames = {
            1: 'å•è¾¹ä¸Šæ¶¨',
            2: 'å•è¾¹ä¸‹è·Œ',
            3: 'ä¸Šå‡ä¸‰è§’å½¢',
            4: 'ä¸‹é™ä¸‰è§’å½¢',
            5: 'å¯¹ç§°ä¸‰è§’å½¢',
            6: 'æ¯çŠ¶å¸¦æŸ„',
            7: 'å¤´è‚©é¡¶',
            8: 'å¤´è‚©åº•',
            9: 'åœ†å¼§é¡¶',
            10: 'åœ†å¼§åº•',
            11: 'å…¶ä»–å½¢æ€'
        };
        
        // åˆå§‹åŒ–
        document.getElementById('periodType').addEventListener('change', function() {
            const customGroup = document.getElementById('customDateGroup');
            customGroup.style.display = this.value === 'custom' ? 'flex' : 'none';
        });
        
        async function analyze() {
            const periodType = document.getElementById('periodType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').innerHTML = 'æ­£åœ¨åˆ†æ...';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsArea').style.display = 'block';
            document.getElementById('statsArea').style.display = 'none';
            document.getElementById('patternTabs').innerHTML = '';
            
            try {
                let url = `${API_BASE}/api/patterns?period_type=${periodType}&use_cache=false`;
                
                if (periodType === 'custom') {
                    if (!startDate || !endDate) {
                        throw new Error('è¯·é€‰æ‹©è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´');
                    }
                    url += `&start_date=${startDate}&end_date=${endDate}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'è¯·æ±‚å¤±è´¥');
                }
                
                currentResults = await response.json();
                displayResults(currentResults);
                
            } catch (error) {
                showError(error.message);
            }
        }
        
        function displayResults(data) {
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            document.getElementById('statsArea').style.display = 'grid';
            document.getElementById('totalStocks').textContent = data.total_stocks;
            
            // è®¡ç®—å¹³å‡æ¶¨å¹…
            let totalReturn = 0;
            let count = 0;
            const patternCounts = {};
            
            data.pattern_groups.forEach(group => {
                patternCounts[group.pattern_name] = group.stocks.length;
                group.stocks.forEach(stock => {
                    if (stock.curr_return !== null) {
                        totalReturn += stock.curr_return;
                        count++;
                    }
                });
            });
            
            const avgReturn = count > 0 ? (totalReturn / count * 100).toFixed(2) : '0.00';
            document.getElementById('avgReturn').textContent = `${avgReturn}%`;
            
            // æ‰¾å‡ºæœ€å¤šçš„å½¢æ€
            let maxPattern = '-';
            let maxCount = 0;
            for (const [name, cnt] of Object.entries(patternCounts)) {
                if (cnt > maxCount) {
                    maxCount = cnt;
                    maxPattern = name;
                }
            }
            document.getElementById('topPattern').textContent = maxPattern;
            
            // ç”Ÿæˆæ ‡ç­¾é¡µ
            const tabsContainer = document.getElementById('patternTabs');
            tabsContainer.innerHTML = '';
            
            data.pattern_groups.forEach((group, index) => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
                btn.textContent = `${group.pattern_name} (${group.stocks.length})`;
                btn.onclick = () => switchTab(group.pattern_type);
                tabsContainer.appendChild(btn);
            });
            
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
            if (data.pattern_groups.length > 0) {
                activeTab = data.pattern_groups[0].pattern_type;
                displayPatternGroup(data.pattern_groups[0], data.current_period, data.previous_period);
            }
            
            document.getElementById('loading').style.display = 'none';
        }
        
        function switchTab(patternType) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(patternNames[patternType])) {
                    btn.classList.add('active');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”çš„åˆ†ç»„
            const group = currentResults.pattern_groups.find(g => g.pattern_type === patternType);
            if (group) {
                displayPatternGroup(group, currentResults.current_period, currentResults.previous_period);
            }
        }
        
        function displayPatternGroup(group, currentPeriod, previousPeriod) {
            const container = document.getElementById('resultsArea');
            
            let html = `
                <div class="pattern-section">
                    <h2 class="pattern-title">
                        ${patternNames[group.pattern_type]}
                        <span style="font-size: 14px; color: #666;">(${group.stocks.length}åªè‚¡ç¥¨)</span>
                    </h2>
            `;
            
            if (group.stocks.length === 0) {
                html += '<p style="color: #666;">æš‚æ— æ•°æ®</p>';
            } else {
                html += `
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨ä»£ç </th>
                                <th>å½“å‰å‘¨æœŸæ¶¨å¹…</th>
                                <th>ä¸Šä¸€å‘¨æœŸæ¶¨å¹…</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // æŒ‰å½“å‰å‘¨æœŸæ¶¨å¹…é™åºæ’åº
                const sortedStocks = [...group.stocks].sort((a, b) => {
                    const retA = a.curr_return || -999;
                    const retB = b.curr_return || -999;
                    return retB - retA;
                });
                
                sortedStocks.forEach(stock => {
                    const currReturn = stock.curr_return !== null 
                        ? `${(stock.curr_return * 100).toFixed(2)}%` 
                        : '-';
                    const prevReturn = stock.prev_return !== null 
                        ? `${(stock.prev_return * 100).toFixed(2)}%` 
                        : '-';
                    
                    const currClass = stock.curr_return > 0 ? 'return-positive' : 
                                     (stock.curr_return < 0 ? 'return-negative' : '');
                    const prevClass = stock.prev_return > 0 ? 'return-positive' : 
                                     (stock.prev_return < 0 ? 'return-negative' : '');
                    
                    html += `
                        <tr>
                            <td><strong>${stock.ts_code}</strong></td>
                            <td class="${currClass}">${currReturn}</td>
                            <td class="${prevClass}">${prevReturn}</td>
                            <td>
                                <button class="btn-secondary" 
                                    style="padding: 5px 10px; font-size: 12px;"
                                    onclick="showStockDetail('${stock.ts_code}', '${currentResults.period_type}')">
                                    è¯¦æƒ…
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function showStockDetail(tsCode, periodType) {
            try {
                const url = `${API_BASE}/api/patterns/${tsCode}?period_type=${periodType}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('è·å–è¯¦æƒ…å¤±è´¥');
                }
                
                const data = await response.json();
                alert(`
è‚¡ç¥¨ä»£ç : ${data.ts_code}
å½¢æ€ç±»å‹: ${data.pattern_name}
å½“å‰å‘¨æœŸ: ${data.current_period.start} è‡³ ${data.current_period.end}
å½“å‰æ¶¨å¹…: ${data.current_period.return !== null ? (data.current_period.return * 100).toFixed(2) + '%' : '-'}
ä¸Šä¸€å‘¨æœŸ: ${data.previous_period.start} è‡³ ${data.previous_period.end}
ä¸Šä¸€æ¶¨å¹…: ${data.previous_period.return !== null ? (data.previous_period.return * 100).toFixed(2) + '%' : '-'}
                `);
            } catch (error) {
                alert('è·å–è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }
        
        async function refreshCache() {
            try {
                showMessage('æ­£åœ¨åˆ·æ–°ç¼“å­˜...', 'info');
                
                const response = await fetch(`${API_BASE}/api/jobs/incremental`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('åˆ·æ–°å¤±è´¥');
                }
                
                showMessage('ç¼“å­˜åˆ·æ–°æˆåŠŸ', 'info');
            } catch (error) {
                showError('åˆ·æ–°ç¼“å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        function showError(message) {
            document.getElementById('messageArea').innerHTML = `
                <div class="error">${message}</div>
            `;
            document.getElementById('loading').style.display = 'none';
        }
        
        function showMessage(message, type) {
            document.getElementById('messageArea').innerHTML = `
                <div class="${type}">${message}</div>
            `;
        }
        
        // æ£€æŸ¥APIå¥åº·çŠ¶æ€
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    console.log('APIæœåŠ¡æ­£å¸¸è¿è¡Œ');
                }
            } catch (error) {
                console.warn('APIæœåŠ¡æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨æœåŠ¡');
            }
        }
        
        checkHealth();
    </script>
</body>
</html>
