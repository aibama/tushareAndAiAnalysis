
你是后端和dba方面的专家，
请帮我将get_stock_returns_in_range涉及到sql，给成mysql8.0支持的窗口函数的逻辑，注意sql的执行效率和性能；
现在数据库的表结构如下：
CREATE TABLE `stocktradetodayinfo` (
  `id` decimal(16,2) DEFAULT NULL,
  `ts_code` varchar(255) NOT NULL,
  `amount` decimal(16,3) DEFAULT NULL,
  `echange` float DEFAULT NULL,
  `close` float DEFAULT NULL,
  `high` float DEFAULT NULL,
  `low` float DEFAULT NULL,
  `open` float DEFAULT NULL,
  `pct_chg` float DEFAULT NULL,
  `pre_close` float DEFAULT NULL,
  `trade_date` datetime(6) DEFAULT NULL,
  `vol` decimal(16,2) DEFAULT NULL,
  `trade_date_tmp` datetime(6) DEFAULT NULL,
  KEY `idx_stocktradedailyinfo_trade_date` (`trade_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;

在\venv\src\crawling\zhituapi目录(已建立)下，通过requests完成两个接口的调用；
接口一get请求：
https://api.zhituapi.com/hs/list/all?token=8657CA7B-E544-4C2A-9540-1F9E28C77ABF
返回：
[
    {
        "dm": "000001.SZ",
        "mc": "平安银行",
        "jys": "SZ"
    },
    {
        "dm": "000002.SZ",
        "mc": "万 科Ａ",
        "jys": "SZ"
    },
    {
        "dm": "000004.SZ",
        "mc": "*ST国华",
        "jys": "SZ"
    },
    {
        "dm": "000006.SZ",
        "mc": "深振业Ａ",
        "jys": "SZ"
    },
    {
        "dm": "000007.SZ",
        "mc": "全新好",
        "jys": "SZ"
    }
]
并将结果解析到表stockinfobase中，表结构如下：
CREATE TABLE stockinfobase (
    ts_code VARCHAR(50) NOT NULL COMMENT '股票代码',
    symbol VARCHAR(50) COMMENT '股票符号',
    name VARCHAR(100) COMMENT '股票名称',
    area VARCHAR(50) COMMENT '地区',
    industry VARCHAR(100) COMMENT '行业',
    list_date VARCHAR(20) COMMENT '上市日期',
    composition VARCHAR(255) COMMENT '成分股信息',
		factory_code VARCHAR(20) COMMENT '交易所,股票对应的交易所',
		line_code VARCHAR(20) COMMENT '股票对应的,代码风险板块，KC科创,SH上海，SZ深圳,CY创业',
    last_update_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '最后更新时间',
    PRIMARY KEY (ts_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='股票基本信息表';
所以dm对应ts_code，mc对应name，jys对应factory_code；
接口二get请求：
http://api.zhituapi.com/hs/instrument/股票代码（如000001.SZ）?token=8657CA7B-E544-4C2A-9540-1F9E28C77ABF
调用速度，每5秒到10秒的随机间隔，调用一次（这个逻辑要完成），用stockinfobase的ts_code数据替换股票代码；返回的数据结构如下：
{"ei":"SH","ii":"600519","name":"贵州茅台","od":"20010827","pc":1486.6000000000001,"up":1635.26,"dp":1337.94,"fv":1252270215.0,"tv":1252270215.0,"pk":0.01,"is":0}
存入到stock_trade_info表，表结构如下：
-- 股票基础信息表
CREATE TABLE `stock_trade_info` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '自增主键ID，用于内部关联',
  `market_code` varchar(10) NOT NULL COMMENT '市场代码，例如: SH（上交所）、SZ（深交所）、BJ（北交所）',
  `stock_symbol` varchar(20) NOT NULL COMMENT '股票交易代码,用于交易的，如000001'',
  `stock_code` varchar(20) NOT NULL COMMENT '股票程序代码,用于程序数据交换的，如000001.SZ',
  `stock_name` varchar(100) NOT NULL COMMENT '股票简称',
  `listing_date` date DEFAULT NULL COMMENT '上市日期',
  `prev_close_price` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '前收盘价',
  `up_limit_price` decimal(10,2) DEFAULT NULL COMMENT '当日涨停价',
  `down_limit_price` decimal(10,2) DEFAULT NULL COMMENT '当日跌停价',
  `float_shares` bigint DEFAULT '0' COMMENT '流通股本（单位：股）',
  `total_shares` bigint DEFAULT '0' COMMENT '总股本（单位：股）',
  `price_tick` decimal(5,2) DEFAULT '0.01' COMMENT '最小价格变动单位',
  `is_suspended` tinyint NOT NULL DEFAULT '0' COMMENT '是否停牌: 0-正常交易，1-停牌',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '记录状态: 0-无效/退市，1-有效',
  `data_source` varchar(50) DEFAULT NULL COMMENT '数据来源标识',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '记录创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '记录最后更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_market_symbol` (`market_code`,`stock_symbol`),
  KEY `idx_symbol` (`stock_symbol`),
  KEY `idx_name` (`stock_name`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='股票基础信息表';
所以接口返回结构和表结构对应关系如下：
ei -> market_code（市场代码）：直接映射，字符串类型，无需转换。
ii -> stock_code（股票程序代码）：直接映射，字符串类型，无需转换。
ii -> stock_symbol（股票交易代码）：去掉ii中的“.SZ”或者“.SH”，得到stock_symbol，注意逻辑，如果没有这种规则，则直接存入。
name -> stock_name（股票名称）：直接映射，字符串类型，无需转换。
od -> listing_date（上市日期）：接口格式通常为‘YYYYMMDD’字符串，入库需用STR_TO_DATE()函数转换为DATE类型。
pc -> prev_close_price（前收盘价格）：接口为浮点数，需转换为DECIMAL(10,2)以精确存储金额，避免浮点精度误差。
up -> up_limit_price（当日涨停价）：同pc字段，需将浮点数转换为DECIMAL(10,2)。
dp -> down_limit_price（当日跌停价）：同pc字段，需将浮点数转换为DECIMAL(10,2)。
fv -> float_shares（流通股本）：接口为浮点数，但股本应为整数。需转换并四舍五入为BIGINT类型，单位是‘股’。
tv -> total_shares（总股本）：同fv字段，需将浮点数转换并四舍五入为BIGINT类型。
pk -> price_tick（最小价格变动单位）：接口为浮点数，需转换为DECIMAL(5,2)，例如0.01元。
is -> is_suspended（是否停牌）：接口中is为整数（≤0正常，≥1停牌天数），需转换为TINYINT。规则：is≤ 0 时置为0（正常交易），
  `data_source` 默认存入：'zhituapi'

使用 `requests` 库调用智途API，获取股票数据并存入MySQL数据库这个需求里面需要优化一个细节：
步骤二的get_all_ts_codes，获取不在stock_trade_info的stockinfobase数据进行拉取接口的数据，因为接口停下来了，需要重启，已经完成的就不需要继续了，另外入库的这个字段的逻辑需要改变下：
ii -> stock_code（股票程序代码）：等于ii+.+ei,例如600519.SH